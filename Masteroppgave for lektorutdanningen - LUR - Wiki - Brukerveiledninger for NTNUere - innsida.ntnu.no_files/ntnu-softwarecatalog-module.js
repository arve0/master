AUI().add("ntnu-softwarecatalog-module",function(a){a.namespace("NTNU.plugin").SoftwareCatalog=b;var c=a.Lang;function b(d){b.superclass.constructor.apply(this,arguments)}b.NAME="SoftwareCatalog";b.NS="SoftwareCatalog";b.ATTRS={hasImportAccess:{value:false},namespace:{value:""},catalogUrl:{value:""},importUrl:{value:""},ratingUrl:{value:""},dialog:{value:""},activeTab:{value:1},catalogItemsNode:{value:null},loadingMaskNode:{value:null},filterCategories:{value:[]},currentCategory:{value:"recommended"},currentTag:{value:""},allReadyAdded:{value:[]},dataModel:{value:{},setter:function(d){this.value=d}}};b.LANG={tabs:{recommendedView:'\u0041\u006e\u0062\u0065\u0066\u0061\u006c\u0074\u0065',recommendedInfo:'\u0053\u0061\u006d\u006c\u0069\u006e\u0067\u0065\u006e\u0020\u0069\u006e\u006e\u0065\u0068\u006f\u006c\u0064\u0065\u0072\u0020\u0062\u00e5\u0064\u0065\u0020\u004e\u0054\u004e\u0055\u002d\u0074\u006a\u0065\u006e\u0065\u0073\u0074\u0065\u0072\u0020\u006f\u0067\u0020\u006e\u0079\u0074\u0074\u0069\u0067\u0065\u0020\u0065\u006b\u0073\u0074\u0065\u0072\u006e\u0065\u0020\u0076\u0065\u0072\u006b\u0074\u00f8\u0079\u002e',alphabeticalView:'\u0041\u002d\u00c5',alphabeticalInfo:'\u0041\u006c\u0066\u0061\u0062\u0065\u0074\u0069\u0073\u006b\u0020\u006f\u0076\u0065\u0072\u0073\u0069\u006b\u0074\u0020\u006f\u0076\u0065\u0072\u0020\u0073\u006d\u00e5\u0070\u0072\u006f\u0067\u0072\u0061\u006d\u006d\u0065\u0072',popularView:'\u0070\u006f\u0070\u0075\u006c\u0061\u0072\u0065\u002d\u0076\u0069\u0065\u0077',popularInfo:'\u0070\u006f\u0070\u0075\u006c\u0061\u0072\u0065\u002d\u0069\u006e\u0066\u006f\u0072\u006d\u0061\u0074\u0069\u006f\u006e',newestView:'\u004e\u0079\u0065\u0073\u0074\u0065',newestInfo:'\u0044\u0065\u0020\u006e\u0079\u0065\u0073\u0074\u0065\u0020\u0073\u006d\u00e5\u0070\u0072\u006f\u0067\u0072\u0061\u006d\u006d\u0065\u006e\u0065'}};b.TABLIST='<ul id="software-catalog-view-mode" class="aui-tabview-list aui-widget-hd tablist yui3-ntnutabs-content"><li class="software-tab ntnu-tab-container"><a href="javascript:void(0);" data-index="1" data-tab="recommended" role="tab" class="ntnu-tab active-tab"><span class="yui-tab-content ntnu-tab-label">{recommendedView}</span></a></li><li class="software-tab ntnu-tab-container"><a href="javascript:void(0);" data-index="2" data-tab="alphabetical" role="tab" class="ntnu-tab"><span class="yui-tab-content ntnu-tab-label">{alphabeticalView}</span></a></li><li class="software-tab ntnu-tab-container"><a href="javascript:void(0);" data-index="3" data-tab="newest" role="tab" class="ntnu-tab"><span class="yui-tab-content ntnu-tab-label">{newestView}</span></a></li></ul>';b.MAIN='<div id="software-catalog" class="software-catalog"><div class="tabs"></div></div>';b.ITEMWRAP='<div id="" class="portlet_stock_item" data-instanceable="{instanceable}" data-addText="{add}" data-confirmText="{confirm}"></div>';b.ADDBTN='<a href="javascript:void(0);" data-portletId="{pluginId}" data-instanceable="{instanceable}" class="portlet_stock_item_btn btn btn-e">{add}</a>';b.THUMB='<span class="scp_thumbnail"><img src="{thumbnailUrl}" alt=""/></span>';b.ITEMHEAD='<h3 class="scp_displayname"><img class="scp_icon" src="{icon}" alt="icon"/>{title}</h3>';b.DESC='<span class="scp_description">{description}</span>';b.META='<span class="scp_meta">{htmlTaglist}</span>';b.TAGS='<a class="tag" href="javascript:void(0);" data-tag="{tag}">{tag}</a>';b.RATING='<span class="portletRating">{averageText}: {averageScore}</span>';b.CLEAR='<div class="clear"></div>';b.CATALOGDOM='<div class="scrollelement"></div>';b.FULLITEM=b.ADDBTN+b.THUMB+b.ITEMHEAD+b.DESC+b.META;a.extend(b,a.Plugin.Base,{initializer:function(){var f=this.get("host");var e=this.get("catalogUrl");var d=this.get("importUrl");var i=this.get("ratingUrl");this.findAllreadyAddedPortletsID();var g={constrain2view:true,destroyOnClose:true,draggable:true,resizable:true,stack:true,width:660,height:450,title:"Programvarekatalog",modal:true,on:{bodyContentChange:function(){}}};if(this.get("hasImportAccess")){g.buttons=[{label:"Import",handler:a.bind(this.loadImportView,this,this.get("importUrl"))},{label:"Back",handler:a.bind(this.loadCatalogView,this,this.get("catalogUrl"))},{label:'\u004c\u0075\u006b\u006b',handler:a.bind(this.closeDialog,this)}]}else{g.buttons=[{label:'\u004c\u0075\u006b\u006b',handler:a.bind(this.closeDialog,this)}]}this.set("dialog",new a.Dialog(g));this.get("dialog").render(f);var h=a.Node.create(b.CATALOGDOM);h.append(a.Node.create(a.substitute(b.TABLIST,b.LANG.tabs)));h.append(a.Node.create('<div id="catalogItems" class="software-catalog"></div>'));this.get("dialog").set("bodyContent",h);this.set("catalogItemsNode",a.one("#catalogItems"));this.set("loadingMaskNode",a.one(".scrollelement"));this.loadCatalogView(this.get("catalogUrl"));f.delegate("click",a.bind(this.addPortletToLayout,this),".portlet_stock_item_btn");f.delegate("click",this.loadImportView,".importSoftwareLink",this,d);f.delegate("click",this.importAppToCatalog,"a.import",this);f.delegate("click",this.browseByTag,".scp_meta a.tag",this);f.delegate("click",this.switchTab,".ntnu-tab",this);this.get("loadingMaskNode").plug(a.LoadingMask,{background:"#fff"});this.get("loadingMaskNode").loadingmask.show();this.after("currentCategoryChange",function(j){this.loadCatalogView(e,j.newVal)});this.after("currentCategoryChange",function(j){});this.after("currentTagChange",function(j){if(j.newVal.length>0){this.loadCatalogView(e)}});this.after("allReadyAddedChange",function(j){this.get("host").all("#catalogItems [data-portletid]").each(function(k){if(this.isPortletAdded(k.getAttribute("data-portletid"))&&k.getAttribute("data-instanceable")=="false"){k.remove()}},this)},this);this.after("activeTabChange",function(j){a.log(j.newVal);this.set("currentTag","");f.all("a[data-index]").removeClass("active-tab");f.one('a[data-index="'+j.newVal+'"]').addClass("active-tab")});this.after("dataModelChange",function(j){this.renderCatalog(j.newVal);this.get("loadingMaskNode").loadingmask.hide()});this.get("dialog").on("destroy",a.bind(this.onDialogDestroy,this))},onDialogDestroy:function(d){this.get("host").unplug(b)},closeDialog:function(){this.get("dialog").close()},loadImportView:function(d){var e={uri:d,method:"GET",on:{start:function(){a.log("starting")},success:function(){a.log("software import success")}}};this.get("catalogItemsNode").plug(a.Plugin.IO,e)},loadCatalogView:function(d){var e=this;var g=new a.DataSource.IO({source:d}),f={success:function(h){e.set("dataModel",h.response.results)},failure:function(h){a.log("Could not retrieve data: "+h.error.message)}};g.plug(a.Plugin.DataSourceJSONSchema,{schema:{resultListLocator:e.get("currentCategory"),resultFields:["averageScore","category","description","icon","instanceable","pluginId","presentInCatalog","productEntryId","tags","thumbnailUrl","title"]}});g.sendRequest({callback:f})},renderCatalog:function(d){var e=this.get("catalogItemsNode");e.empty();this.createItems(d,e);this.findAllreadyAddedPortletsID()},createItems:function(d,f){var e=this.get("currentTag");var g=this;a.Array.each(d,function(i){if(e.length==0||a.Array.indexOf(i.tags,e)!=-1){if(!i.thumbnailUrl){i.thumbnailUrl='\u002f\u0067\u006c\u006f\u0062\u0061\u006c\u002d\u0063\u006c\u0069\u0065\u006e\u0074\u0073\u0069\u0064\u0065\u002d\u0070\u006f\u0072\u0074\u006c\u0065\u0074\u002f\u0069\u006d\u0061\u0067\u0065\u0073\u002f\u0073\u006f\u0066\u0074\u0077\u0061\u0072\u0065\u002d\u0063\u0061\u0074\u0061\u006c\u006f\u0067\u002f\u006e\u0074\u006e\u0075\u002d\u0061\u0070\u0070\u0073\u0063\u0061\u0074\u0061\u006c\u006f\u0067\u002d\u0074\u0068\u0075\u006d\u0062\u006e\u0061\u0069\u006c\u002d\u0039\u0035\u0062\u0064\u0031\u0063\u002e\u0070\u006e\u0067'}if(!i.icon){i.icon='\u002f\u0067\u006c\u006f\u0062\u0061\u006c\u002d\u0063\u006c\u0069\u0065\u006e\u0074\u0073\u0069\u0064\u0065\u002d\u0070\u006f\u0072\u0074\u006c\u0065\u0074\u002f\u0069\u006d\u0061\u0067\u0065\u0073\u002f\u0073\u006f\u0066\u0074\u0077\u0061\u0072\u0065\u002d\u0063\u0061\u0074\u0061\u006c\u006f\u0067\u002f\u006e\u0074\u006e\u0075\u002d\u0061\u0070\u0070\u0073\u0063\u0061\u0074\u0061\u006c\u006f\u0067\u002d\u0074\u0068\u0075\u006d\u0062\u006e\u0061\u0069\u006c\u002d\u0039\u0035\u0062\u0064\u0031\u0063\u002e\u0070\u006e\u0067'}i.add=g.isPortletAdded(i.pluginId)?'\u004c\u0061\u0067\u0074\u0020\u0074\u0069\u006c':'\u004c\u0065\u0067\u0067\u0020\u0074\u0069\u006c';i.confirm='\u0050\u0072\u006f\u0067\u0072\u0061\u006d\u006d\u0065\u0074\u0020\u0065\u0072\u0020\u006c\u0061\u0067\u0074\u0020\u0074\u0069\u006c\u0020\u006f\u0067\u0020\u006c\u0069\u0067\u0067\u0065\u0072\u0020\u0070\u00e5\u0020\u0073\u0069\u0064\u0065\u006e\u002e';i.averageText='\u0047\u006a\u0065\u006e\u006e\u006f\u006d\u0073\u006e\u0069\u0074\u0074\u006c\u0069\u0067\u0020\u0072\u0061\u006e\u0067\u0065\u0072\u0069\u006e\u0067';i.htmlTaglist=a.Array.map(i.tags,function(j){return a.substitute(b.TAGS,{tag:j})}).join(", ");var h=a.Node.create(a.substitute(b.ITEMWRAP,i));h.append(a.Node.create(a.substitute(b.FULLITEM,i)));h.append(a.Node.create(b.CLEAR));f.append(h)}})},switchTab:function(d){this.set("activeTab",d.currentTarget.getAttribute("data-index"));this.set("currentCategory",d.currentTarget.getAttribute("data-tab"))},browseByTag:function(d){this.set("currentTag",d.currentTarget.getAttribute("data-tag"))},rateThisPortlet:function(g,e,f){var d=g.currentTarget;var h=d.all(".aui-rating-element-on").size();a.log(h);a.io(e+"?rating="+h+"&portletId=1",{on:{success:function(j,i){a.log(i.responseText)}}})},importAppToCatalog:function(e){var f=e.currentTarget;var d=f.getAttribute("data-portlet-title");a.io.request(f.getAttribute("data-import-url"),{method:"GET",on:{success:function(){f.ancestor("li").addClass("highlight")},failure:function(){alert('\u0046\u0069\u006b\u006b\u0020\u0069\u006b\u006b\u0065\u0020\u0074\u0069\u006c\u0020\u00e5\u0020\u0069\u006d\u0070\u006f\u0072\u0074\u0065\u0072\u0065'+" "+d)}}})},showDialogContent:function(e,d){a.one(".software-catalog").show()},addPortletToLayout:function(d){a.log("click add software");var g=d.currentTarget;g.text('\u004c\u0061\u0067\u0074\u0020\u0074\u0069\u006c').addClass("btn-b").removeClass("btn-e").removeClass("sw-loadingbutton");var o=g.getAttribute("data-addText");var m=g.getAttribute("data-confirmText");var l=g.getAttribute("data-portletId");var j=g.getAttribute("data-instanceable");var k=l;if(j=="true"){var n=new a.NTNU.ObjectUtil();k=l+"_INSTANCE_"+n.randomString(4)}if(!a.one("#myPortletPlaceholderDiv")){a.Node.create('<div id="myPortletPlaceholderDiv" class="loading-animation" />').appendTo("#column-1")}var h=Liferay.ThemeDisplay.getPlid();var f=null;var i=function(p){a.log("Logging placeholder");a.log(p)};var e={beforePortletLoaded:i,onComplete:a.bind(this.addPortletCallBack,this),onEnd:function(){},plid:h,portletId:k,placeHolder:"#myPortletPlaceholderDiv"};Liferay.Portlet.add(e)},addPortletCallBack:function(e,d){a.log("portletBoundary: "+e);a.log("Portletid: "+d);this.findAllreadyAddedPortletsID()},resetTabFilter:function(g,f){var d=g.currentTarget;var e=d.getAttribute("data-resourceUrl");this.loadCatalogView(g,e)},findAllreadyAddedPortletsID:function(){var d=a.one("body").all(".portlet-boundary");var e=[];d.each(function(f){e.push(f.guid())});this.set("allReadyAdded",e)},isPortletAdded:function(e){var d=false;a.Array.each(this.get("allReadyAdded"),function(f){if(f.indexOf(e)!=-1){d=true}});return d}})},"1.0.1",{requires:["aui-io","aui-dialog","datasource-io","datasource-jsonschema","substitute","aui-loading-mask","ntnu-object-util","liferay-layout-column","liferay-layout"]});