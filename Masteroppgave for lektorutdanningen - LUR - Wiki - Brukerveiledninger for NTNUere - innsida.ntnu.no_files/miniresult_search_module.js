AUI().add("ntnu-search-miniresult",function(a){a.namespace("NTNU");a.NTNU.SearchMiniResult=function(h){var b=new a.NTNU.ObjectUtil();var e=b.validateLiteral(h,["portletNameSpace","resultNode","inputNode"]);this.jsonFormater=new a.NTNU.SearchResultFormater();this.NS=e.portletNameSpace;this.resultNodeLocation=e.inputNode;this.overLayNode=e.resultNode;if(!this.resultNodeLocation||!this.overLayNode){throw new ReferenceError("No reference pointer to either locationID or nodeID")}this.overLayNode.setAttribute("role","dialog");this.currentResultNode="";function g(){this.resultDisplayOverlay.hide();this.resultNodeLocation.focus()}a.on("ntnu:hideMiniResult",a.bind(g,this));this.resultDisplayOverlay=new a.OverlayContextPanel({bodyContent:"no content yet!",boundingBox:this.overLayNode,trigger:"#trigger",cancellableHide:true,hideDelay:200,hideOnDocumentClick:true,anim:true,height:"340px",width:"600px",cssClass:"miniResultBox",align:{node:"#trigger",points:["tl","bl"]}});var d=this.resultDisplayOverlay.get("boundingBox");if(d){d.delegate("click",c,".miniResultItem");d.on("key",function(i){a.fire("ntnu:hideMiniResult")},"down:27");this.resultNodeLocation.on("key",function(){if(d.one("a")){d.one("a").focus();a.one("body").addClass("preventScroll")}},"down:40")}function c(m){m.preventDefault();var k="";var n=m.target;var l=m.currentTarget;var j;if(n.hasClass("rss-feed-icon")){k=n.ancestor("a").getAttribute("href")}else{if(n.hasClass("search-result-channel-rss")){k=n.getAttribute("href")}else{k=l.getAttribute("data-url")}}a.log("Url: "+k);if(k!=null&&k.length>0){j=l.hasClass("message")?f(k):k;var i=new UrlNavigator({url:j});i.go()}}function f(i){var k=a.one(".activeRole[data-item-name]");var j="";if(k){var l="/hvaskjer?p_p_id=readadvancedportlet_WAR_messageserviceportlets&messageId=";j=k.getAttribute("href")}else{throw new Error("Could not find the active role for user")}return j+l+i}this.showMiniResult=function(){var j=a.one(".ntnu-search-result-portlet");this.resultDisplayOverlay.show();var i=this.resultNodeLocation.getXY();i[1]=i[1]+32;i[0]=i[0]-235;this.resultDisplayOverlay._setX(i[0]);this.resultDisplayOverlay._setY(i[1]);if(Liferay.Browser.isIe()&&Liferay.Browser.getMajorVersion()<=8){var l=a.one(".searchComponentWrapper");var k=l.all(".aui-widget-bd, .miniResultBox-content");if(k){k.setStyles({height:"340px"});a.log("Setting 340!!")}}};this.hideMiniResult=function(){this.resultDisplayOverlay.hide();this.resultNodeLocation.focus();a.one("body").removeClass("preventScroll");this.purgeStore()};this.purgeStore=function(){var i=this.getResultDomReference();if(i){i.empty()}};this.getResultDomReference=function(){var k=a.one("#"+this.NS+"storeNodeMiniResult");var i=k?k:a.Node.create('<div id="#'+this.NS+'storeNodeMiniResult"></div>');if(i){var j={overflowX:"hidden",overflowY:"scroll",height:"280px"};i.setStyles(j);i.addClass("resultItemParentElement")}return i};this.focusResult=function(){this.getResultDomReference().focus()}};a.NTNU.SearchMiniResult.prototype.formatAjaxresponse=function(e){var g=this.getResultDomReference();if(g){this.purgeStore()}if(e.length>0){var c=0;for(c=0;e.length>c;c++){if(e[c].type=="PERSON"){var d=this.jsonFormater.formatPerson(e[c]);g.append(d)}else{if(e[c].type=="WEB_DOCUMENT"){var b=this.jsonFormater.formatDocument(e[c]);g.append(b)}else{if(e[c].type=="MESSAGE"){var f=this.jsonFormater.formatMessage(e[c]);g.append(f)}else{if(e[c].type=="COURSE"){var f=this.jsonFormater.formatCourse(e[c]);g.append(f)}else{if(e[c].type=="STUDYPROG"){var f=this.jsonFormater.formatStudyProg(e[c]);g.append(f)}else{if(e[c].type=="ORGANIZATION"){var f=this.jsonFormater.formatOrganization(e[c]);g.append(f)}else{a.log("No json formater found for searchtype: "+e[c].type)}}}}}}}}if(Liferay.Browser.isIe()){this.resultDisplayOverlay.set("bodyContent",g.outerHTML())}else{this.resultDisplayOverlay.set("bodyContent",g)}this.resultDisplayOverlay.render();a.fire("ntnu:search-miniresult:rendered")};a.NTNU.SearchMiniResult.prototype.enableFocusManager=function(){var b=a.one(".resultItemParentElement");if(!b){throw new ReferenceError("No reference to miniResultBox-content")}b.plug(a.Plugin.NodeFocusManager,{descendants:"p.miniResultItem a.title",keys:{next:"down:40",previous:"down:38"},focusClass:{className:"seachHighlight",fn:function(e){var c=e.ancestor("p.miniResultItem");var d=c.next("p.miniResultItem")?c.next("p.miniResultItem"):c;if(!Liferay.Browser.isIe()){d.one(".focusSpanNode").scrollIntoView()}return c}},circular:false})};a.NTNU.SearchResultFormater=function(){this.util=new a.NTNU.ObjectUtil()};a.NTNU.SearchResultFormater.prototype.formatStudyProg=function(f){var c=this.util.getFileTypeByExtention(f.url);var d=a.Node.create("<p></p>");d.addClass("miniResultItem");d.addClass(f.type.toLowerCase());d.setAttribute("data-url",f.url);d.setAttribute("data-form-action","goto");var g=a.Node.create('<a class="title" href="javascript:void(0);">'+f.title+"</a>");g.setAttribute("data-url",f.url);d.append(g);if(this.util.hasPropAndValue(f,"studyLevel")){var b=a.Node.create('<span class="studyLevel">'+f.studyLevel+"</span>");d.append(b)}if(this.util.hasPropAndValue(f,"studyProgCode")){var e=a.Node.create('<span class="codeAndOrgNode">'+f.studyProgCode+" - "+f.orgName+" </span>");d.appendChild(e)}return d};a.NTNU.SearchResultFormater.prototype.formatCourse=function(h){var g={NORSK:'\u004e\u006f\u0072\u0073\u006b',ENGELSK:'\u0045\u006e\u0067\u0065\u006c\u0073\u006b'};var j=this.util.getFileTypeByExtention(h.url);var d=a.Node.create("<p></p>");d.addClass("miniResultItem");d.addClass(h.type.toLowerCase());d.setAttribute("data-url",h.url);d.setAttribute("data-form-action","goto");var i=a.Node.create('<a class="title" href="javascript:void(0);">'+h.courseCode+" - "+h.title+"</a>");i.setAttribute("data-url",h.url);d.append(i);if(this.util.hasPropAndValue(h,"orgName")){var c=a.Node.create('<span class="orgName">'+h.orgName+"</span>");d.append(c)}if(h.jsonData!=undefined){if(h.jsonData.courseCredit!=undefined){var b="";if(h.jsonData.courseLanguages.length>0){var e=[];a.Array.forEach(h.jsonData.courseLanguages,function(k){e.push(g[k])});b='\u0055\u006e\u0064\u0065\u0072\u0076\u0069\u0073\u006e\u0069\u006e\u0067\u0073\u0073\u0070\u0072\u00e5\u006b\u003a'+e.join(", ")+". "}var f=a.Node.create('<span class="courseCreditLanguageNode">'+b+" "+'\u0053\u0074\u0075\u0064\u0069\u0065\u0070\u006f\u0065\u006e\u0067\u003a'+h.jsonData.courseCredit+" </span>");d.appendChild(f)}}return d};a.NTNU.SearchResultFormater.prototype.formatDocument=function(e){var b=this.util.getFileTypeByExtention(e.url);var c=a.Node.create("<p></p>");c.addClass("miniResultItem");c.addClass(e.type.toLowerCase());c.setAttribute("data-url",e.url);c.addClass(b);c.setAttribute("data-form-action","goto");var g=a.Node.create('<a class="title" href="javascript:void(0);">'+e.title+"</a>");g.setAttribute("data-url",e.url);c.append(g);if(this.util.hasPropAndValue(e,"teaser")){var d=a.Node.create('<span class="teaser">'+e.teaser+"</span>");c.append(d)}var f=a.Node.create('<span class="focusSpanNode"></span>');c.appendChild(f);return c};a.NTNU.SearchResultFormater.prototype.formatOrganization=function(e){var b=this.util.getFileTypeByExtention(e.url);var c=a.Node.create("<p></p>");c.addClass("miniResultItem");c.addClass(e.type.toLowerCase()+" HMM");if(e.url!=null){c.setAttribute("data-url",e.url);c.setAttribute("data-form-action","goto")}if(e.address==null){e.address=""}if(e.phone==null){e.phone=""}var g=null;if(e.url!=null){g=a.Node.create('<a class="title" href="javascript:void(0);">'+e.title+"</a>");g.setAttribute("data-url",e.url)}else{g=a.Node.create('<div class="title">'+e.title+"</div>")}c.append(g);var d=a.Node.create('<span class="teaser">'+e.phone+" "+e.email+"<br/>"+e.address+"</span>");c.append(d);var f=a.Node.create('<span class="focusSpanNode"></span>');c.appendChild(f);return c};a.NTNU.SearchResultFormater.prototype.formatPerson=function(b){var c=a.Node.create("<p></p>");c.addClass("miniResultItem");c.addClass(b.type.toLowerCase());c.setAttribute("data-url",b.personUrl);c.setAttribute("data-form-action","goto");if(this.util.hasPropAndValue(b,"pictureUrl")){var i=a.Node.create("<img/>");i.setAttrs({src:b.pictureUrl,alt:b.title,width:"50",height:"50"});i.addClass("miniresult-profile-image");c.appendChild(i)}var e;if(this.util.hasPropAndValue(b,"personUrl")){e=a.Node.create('<a class="title">'+b.title+"</a>");e.setAttribute("href",b.personUrl)}else{e=a.Node.create('<span class="title">'+b.title+"</span>")}c.appendChild(e);if(this.util.hasPropAndValue(b,"roleTitle")){var f=a.Node.create("<span>"+b.roleTitle+"</span>");c.appendChild(f)}if(this.util.hasPropAndValue(b,"email")){var h=a.Node.create('<a class="emaillink"></a>');h.setAttribute("href","mailto:"+b.email);h.text(b.email);var j=a.Node.create("<span></span>");j.addClass("mail");j.appendChild(h);c.appendChild(j)}if(this.util.hasPropAndValue(b,"cellPhone")){var g=a.Node.create("<span>"+b.cellPhone+"</span>");g.addClass("phone");c.appendChild(g)}var d=a.Node.create('<span class="focusSpanNode"></span>');c.appendChild(d);return c};a.NTNU.SearchResultFormater.prototype.formatMessage=function(e){var i=e;var b=a.Node.create("<p></p>");b.addClass("miniResultItem");b.addClass(i.type.toLowerCase());b.setAttribute("data-url",i.id);b.setAttribute("data-form-action","goto");if(this.util.hasPropAndValue(i,"channel")){var f=a.Node.create('<span class="search-result-channel-rss"></span>');var k=window.location.protocol+"//"+window.location.host;var h=a.Node.create('<img class="rss-feed-icon" data-feedurl="'+i.channel+'"/>');h.setAttrs({src:k+"/global-clientside-portlet/images/search_portlet/icons/feed-icon.png"});h.on("click",function(p){var o=p.currentTarget;var n=o.getAttribute("data-feedurl");var m=new UrlNavigator({url:n});m.go()});f.append(h);b.append(f)}var g=a.Node.create('<a class="title" href="javascript:void(0);">'+i.title+"</a>");g.setAttribute("data-url",i.id);b.append(g);if(this.util.hasPropAndValue(i,"teaser")){var l=a.Node.create('<span class="teaser">'+i.teaser+"</span>");b.append(l)}var c=i.publicationDate+", "+i.channelName;if(this.util.hasPropAndValue(i,"author")){c+=", "+i.author}var j=a.Node.create('<span class="searchResultDetails">'+c+"</span>");b.append(j);var d=a.Node.create('<span class="focusSpanNode"></span>');b.appendChild(d);return b}},"3.1.1",{requires:["ntnu-object-util","aui-overlay","aui-node"]});