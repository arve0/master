AUI().add("ntnu-toolbar-events",function(a){a.namespace("NTNU");var b={li:'<li class="type-{eventType}" data-id="{id}"><a href="{target}"><div class="content">{content}</div><div class="created" title="{createdFormattedTime}">{displayableTime}</div></a></li>'};a.NTNU.Toolbarevents=function(e){var m=false;var k;var l=a.Node.create('<span class="icon">&nbsp;</span><span class="count">0</span>');var h=l.one(".count");var o=0;var j=false;var p=function(v,r){r.removeClass("loader");var s=[];var t=0;var q=v.length;for(t;t<q;t++){v[t].createdFormattedTime=new Date(v[t].createdTime).toLocaleString();var u=a.Node.create(a.substitute(b.li,v[t]));if(v[t].displayed===false){u.addClass("unread");s.push(v[t].id)}r.appendChild(u)}a.one("body").appendChild(a.Node.create('<div id="eventOverlay"></div>'));var w=a.Node.create('<li class="more"><a href="javascript:;">'+'\u0046\u006c\u0065\u0072\u0065\u0020\u0076\u0061\u0072\u0073\u0065\u006c'+"</a></li>");w.on("click",f);r.appendChild(w);i(s)};var n=function(){k=a.Node.create('<div class="eventwrap"><ul class="eventlist loader"></ul></div>');var q=k.one("ul");e.targetNode.ancestor("div.rightRoundedCorner").appendChild(k);a.io.request(e.eventListUrl,{dataType:"json",on:{success:function(){var r=this.get("responseData");r.objects=r.objects||[];p(r.objects,q)},failure:function(){p([],q)}}})};var c=function(q){q.count=q.count||0;h.set("text",q.count+"");if(q.count>0){e.targetNode.addClass("new")}else{e.targetNode.removeClass("new")}};var i=function(q){a.io.request(e.markEventUrl,{dataType:"json",data:{notificationIds:q},on:{success:function(){var r=this.get("responseData");r=typeof r==="object"?r:{};r.objects=r.objects||{};c(r.objects)},failure:function(){}}})};var g=function(){if(!j){a.io.request(e.eventNumberUrl,{dataType:"json",on:{success:function(){var q=this.get("responseData");q=typeof q==="object"?q:{};q.objects=q.objects||{};c(q.objects)},failure:function(){clearInterval(o)}}})}};var f=function(){if(!m){return}var q=Math.max(0,k.all("li").size()-1);a.io.request(e.eventListUrl,{dataType:"json",data:{notificationLimit:0},on:{success:function(){var w=this.get("responseData");var s=k.one("ul");k.addClass("all");k.setStyle("height",k.get("clientHeight")+45);if(w.objects&&w.objects.length>q){var u=q;var r=w.objects.length;var t=[];w=w.objects;for(u;u<r;u++){w[u].createdFormattedTime=new Date(w[u].createdTime).toLocaleString();var v=a.Node.create(a.substitute(b.li,w[u]));if(w[u].displayed===false){v.addClass("unread");t.push(w[u].id)}s.appendChild(v)}i(t)}}}})};var d=function(){if(k){k.remove();k=null;a.one("#eventOverlay").remove()}m=false};e.targetNode.on("click",function(q){if(!m){n();m=true}});a.one("body").delegate("click",d,"#eventOverlay");e.targetNode.appendChild(l);o=setInterval(g,1000*120);a.IdleTimer.subscribe("idle",function(){j=true});a.IdleTimer.subscribe("active",function(){j=false});a.IdleTimer.start(600*1000);g()}},"1.0.0",{requires:["aui-node","aui-io","substitute","idle-timer"]});